# Sentinel Architecture

## Overview

Sentinel follows a real-time supervision model where an agent runs in a loop making LLM calls and tool calls, while a supervisor monitors in real-time, detecting boundaries, extracting claims, binding evidence, and intervening when needed.

## Core Components

### Trace System (`sentinel/trace/`)

- **Purpose**: Foundation for all event logging
- **Key Files**:
  - `schema.py`: Pydantic models for events (Event, EventType)
  - `store_jsonl.py`: JSONL-based trace store with file locking
  - `replay.py`: Utilities for loading and replaying events

**Event Types**:
- `llm_call`: LLM API calls with prompts and responses
- `tool_call`: Tool execution with parameters
- `observation`: Tool results and observations
- `artifact`: Generated artifacts (PRD, Launch Plan)
- `decision`: Supervisor decisions and boundary detections
- `intervention`: Interventions generated by supervisor
- `escalation_packet`: Escalation packets created

### GitHub Integration (`sentinel/github/`)

- **Purpose**: Fetch and cache GitHub milestone data
- **Key Files**:
  - `client.py`: GitHub API client with rate limiting
  - `cache.py`: File-based cache (~/.cache/sentinel/)
  - `fetch.py`: Bundle fetcher that normalizes GitHub data

### Agent (`sentinel/agent/`)

- **Purpose**: LLM-based agent that generates PRD and Launch Plan
- **Key Files**:
  - `prd_writer.py`: PRDAgent class with tool calling
  - `loop.py`: Orchestration of agent + supervisor

**Agent Tools**:
- `github_fetch_issue(issue_num)`: Fetch specific issue
- `github_fetch_comments(issue_num)`: Fetch issue comments
- `read_file(path)`: Read existing files
- `write_file(path, content)`: Write PRD sections
- `search_issues(query)`: Search issues by keyword

### Evidence System (`sentinel/evidence/`)

- **Purpose**: Extract claims and bind evidence
- **Key Files**:
  - `claims.py`: Extract claims from markdown artifacts
  - `graph.py`: In-memory graph tracking claims, evidence, and relationships
  - `bind.py`: Bind evidence to claims using keyword matching

**Claim Severity**:
- `HIGH`: Goals, Scope, Metrics, Rollout commitments
- `MEDIUM`: Risks
- `LOW`: Narrative and other content

### Boundary Detection (`sentinel/boundaries/`)

- **Purpose**: Detect decision boundaries in real-time
- **Key Files**:
  - `detect.py`: Heuristics for boundary detection

**Boundary Types**:
- `missing_evidence`: HIGH claim without evidence
- `empty_metrics`: Metrics section without measurable indicators
- `missing_tradeoffs`: Scope section without explicit tradeoffs
- `low_evidence_rate`: Many tool calls without evidence binding

### Interventions (`sentinel/interventions/`)

- **Purpose**: Generate interventions and apply policies
- **Key Files**:
  - `types.py`: Intervention types and data structures
  - `policy.py`: Supervisor with policy rules

**Intervention Types**:
- `REQUEST_EVIDENCE`: Request evidence for uncovered claims
- `REQUEST_METRICS`: Request measurable metrics
- `REQUEST_OPTIONS`: Request tradeoff analysis
- `ESCALATE`: Escalate to human review

### Packets (`sentinel/packets/`)

- **Purpose**: Generate escalation packets for human review
- **Key Files**:
  - `decision_packet.py`: Markdown packet generator

### Reporting (`sentinel/report/`)

- **Purpose**: Generate summary reports
- **Key Files**:
  - `render_md.py`: Markdown report generator

## Data Flow

```
1. CLI invokes run_agent_with_supervisor()
2. Fetch GitHub milestone bundle (cached or from API)
3. Initialize agent with bundle
4. Agent loop:
   a. Agent makes LLM call → emits llm_call event
   b. LLM returns tool call → agent executes → emits tool_call event
   c. Tool result → emits observation event
   d. Supervisor analyzes recent events
   e. Supervisor extracts claims from artifacts
   f. Supervisor binds evidence from bundle and observations
   g. Supervisor detects boundaries
   h. Supervisor generates intervention if needed
   i. If ESCALATE, generate packet and break
5. Generate final report
```

## Configuration

- **Cache**: `~/.cache/sentinel/` (XDG standard)
- **Data**: `data/` (project-relative)
- **Runs**: `runs/` (project-relative)

## Dependencies

- `requests`: GitHub API client
- `openai`: LLM API client
- `pydantic`: Data validation
- `python-dateutil`: Date parsing

## Testing

Tests use mocked LLM responses to avoid API calls. See `tests/test_smoke.py` for example.
